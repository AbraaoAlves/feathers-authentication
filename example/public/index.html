<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title>Feathers Authentication</title>
</head>
<body>
  <h1>Feathers Local Authentication Examples</h1>

  <section>
    <h3>Email/Password authentication via REST</h3>
    <p>Username: <code>admin@feathersjs.com</code></p>
    <p>Password: <code>admin</code></p>

    <form action="/auth/local" method="post">
      <div>
        <label>Email:</label>
        <input type="text" name="email" value="admin@feathersjs.com"/>
      </div>
      <div>
        <label>Password:</label>
        <input type="password" name="password" value="admin"/>
      </div>

      <button id="email-password-rest-button">Login</button>
    </form>
  </section>

  <section>
    <h3>Token based authentication via REST</h3>

    <form action="/auth/token" method="post">
      <div>
        <label>Token:</label>
        <input type="text" name="token" value=""/>
      </div>
      
      <button id="token-rest-button">Login</button>
    </form>
  </section>

  <section>
    <h3>Basic email/password authentication via socket</h3>
    <form action="/auth/local" method="post">
      <div>
        <label>Email:</label>
        <input type="text" name="email" value="admin@feathersjs.com"/>
      </div>
      <div>
        <label>Password:</label>
        <input type="password" name="password" value="admin"/>
      </div>

      <button id="email-password-socket-button">Login</button>
    </form>
  </section>

  <section>
    <h3>Token based authentication via socket</h3>
    <form action="/auth/token" method="post">
      <div>
        <label>Token:</label>
        <input type="text" name="token" value=""/>
      </div>

      <button id="token-socket-button">Login</button>
    </form>
  </section>
  
  <pre id="messages"></pre>

  <script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
  <script src="socket.io/socket.io.js" type="text/javascript"></script>
  <script type="text/javascript">
    var host = 'http://localhost:3030';
    var socket = io(host, {
      transport: ['websockets']
    });

    socket.on('unauthorized', function(error) {
      alert('Your socket authentication request failed.');
      console.error(error);
    });

    socket.on('connect', function() {
      console.log('Socket connected');

      socket.on('authenticated', function (data) {
        alert('You successfully authenticated over socket.io. Your new JWT is:\n\n' + data.token);
        console.log('Authenticated via socket', data);
        // Now that we are authenticated, fetch something that
        // requires a logged in user. Maybe we don't have to send the token
        // each time.
        // TODO (EK): Should just store the token in local storage;
        
        // socket.emit('messages::find', {token: token}, function(error, messages) {
        //   console.log(messages);
        //   messages.forEach(function(message){
        //     messageList.innerHTML += message.text + '<br/>';
        //   });
        // });
      });
    });

    (function ($) {
      $.fn.serializeForm = function () {
        var o = {};
        var a = this.serializeArray();
        $.each(a, function () {
          if (o[this.name]) {
            if (!o[this.name].push) {
              o[this.name] = [o[this.name]];
            }
            o[this.name].push(this.value || '');
          } else {
            o[this.name] = this.value || '';
          }
        });
        return o;
      };
    })(jQuery);

    $(document).on('ready', function(){
      $('#email-password-rest-button').on('click', function(ev){
        ev.preventDefault();

        $.ajax({
          type: "POST",
          url: host + '/auth/local',
          data: $(ev.target).closest('form').serialize(),
          success: function(data) {
            console.log('Authenticated via email/password over REST', data);
            alert('You successfully authenticated using email and password over REST. Your new JWT is:\n\n' + data.token);
          },
          error: function(error) {
            console.error(error);
          }
        });
      });

      $('#token-rest-button').on('click', function(ev){
        ev.preventDefault();

        $.ajax({
          type: "POST",
          url: host + '/auth/token',
          data: $(ev.target).closest('form').serialize(),
          success: function(data) {
            console.log('Authenticated via token over REST', data);
            alert('You successfully authenticated using JWT over REST. Your new JWT is:\n\n' + data.token);
          },
          error: function(error) {
            console.error(error);
          }
        });
      });

      $('#email-password-socket-button').on('click', function(ev){
        ev.preventDefault();

        var data = $(ev.target).closest('form').serializeForm();

        socket.emit('authenticate', data);
      });

      $('#token-socket-button').on('click', function(ev){
        ev.preventDefault();

        var data = $(ev.target).closest('form').serializeForm();

        socket.emit('authenticate', data);
      });
    });
  </script>
</body>
</html>